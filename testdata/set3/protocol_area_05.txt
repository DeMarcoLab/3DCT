[euler_out shift_out rott]=tom_sum_rotation([178.704 -70.785 -75.866;64.753 -172.737 18.668],[0 0 0; 0 0 0]);

FIB_ang = [70.785 -178.704 75.866];
FIB_scale = 1.093;
FIB_trans = [-166.22533056 -315.05247416];
SEM_ang = [64.753 -172.737 18.668];
SEM_scale = 0.702;
SEM_trans = [62.6463373   -92.35041209];

raw = tom_rawread('/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/150826_correlation_done/Area_05/40x_g2_SD5-0_resliced.raw','uint16','be',[1344 1024 132],0,0);
raw = single(raw);
raw = quadvol(raw,0);

vol_rot = tom_rotate(raw,FIB_ang);pushover('First Rotation Finished');

imwrite(tom_norm(max(vol_rot,[],3),1)','/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/150826_correlation_done/Area_05/vol_rot_FIB.tif');

vol_rot(1:(446+166.22533056)/FIB_scale,:,:)=0;
vol_rot((644+166.22533056)/FIB_scale:end,:,:)=0;
vol_rot(:,1:(451+315.05247416)/FIB_scale,:)=0;
vol_rot(:,(455+315.05247416)/FIB_scale:end,:)=0;

imwrite(tom_norm(max(vol_rot,[],3),1)','/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/150826_correlation_done/Area_05/vol_rot_FIB_cut.tif');

vol_rot_back = tom_rotate(vol_rot,euler_out);pushover('Back Rotation Finished');

imwrite(tom_norm(max(vol_rot_back,[],3),1)','/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/150826_correlation_done/Area_05/vol_rot_FIB_cut_SEM.tif');

im = imresize(tom_norm(max(vol_rot_back,[],3),1)',SEM_scale);
im_shift = tom_shift(im, SEM_trans);
imwrite(tom_norm(max(vol_rot_back,[],3),1)','/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/150826_correlation_done/Area_05/vol_rot_SEM_scale_shift.tif');






FIB IB-16:

rawpath = '/fs/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area1/sh2_g2_40x_SD_area1-0_aligned_decon_ch00_reslized.raw';
rawpath = '/fs/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area1/sh2_g2_40x_SD_area1-0_aligned_decon_ch01_reslized.raw';
angleFIB = [-151.996 -178.585 72.646];
angleFIB_milled = [-151.741 -178.513 77.256];
angleSEM = [-157.025 -173.476 23.852];
[euler_out shift_out rott]=tom_sum_rotation([178.585 151.996 -72.646;-157.025 -173.476 23.852],[0 0 0; 0 0 0]);
[euler_out shift_out rott]=tom_sum_rotation([178.513 151.741 -77.256;-157.025 -173.476 23.852],[0 0 0; 0 0 0]);
size = [1344 1024 76];

raw = tom_rawread(rawpath,'int16','be',size,0,0);
raw = tom_rawread(rawpath,'uint16','be',size,0,0);
raw = single(raw);
raw = quadvol(raw,0);

vol_rot = tom_rotate(raw,angleFIB_milled);


vol_rot(1:(532+15.711)/0.866,:,:)=0;
vol_rot((616+15.711)/0.866:end,:,:)=0;
vol_rot(:,1:(394+174.724)/0.866,:)=0;
vol_rot(:,(397+174.724)/0.866:end,:)=0;
figure; imshow(tom_norm(max(vol_rot,[],3),1)');

opt:
[euler_out shift_out rott]=tom_sum_rotation([178.538 151.694 -77.234;-157.025 -173.476 23.852],[0 0 0; 0 0 0]);
vol_rot(1:(532+16.26866465)/0.867,:,:)=0;
vol_rot((616+16.26866465)/0.867:end,:,:)=0;
vol_rot(:,1:(394+175.02668592-8)/0.867,:)=0;
vol_rot(:,(397+175.02668592-8)/0.867:end,:)=0;
figure; imshow(tom_norm(max(vol_rot,[],3),1)');


vol_rot_back = tom_rotate(vol_rot,euler_out);


% vol = tom_emread('/fs/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area5/Area5_processed_deconv/vol_ch00_rot_FIB.em');
% tom_emwrite('/fs/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area5/Area5_processed_deconv/vol_ch00_rot_FIB.em',vol);

% cut out:
vol_rot(1:(492.52013809+83.8895281933),:,:)=0;
vol_rot((616.800920598+83.8895281933):end,:,:)=0;
vol_rot(:,1:(504.027617952+275.500575374),:)=0;
vol_rot(:,(506.329113924+275.500575374):end,:)=0;
figure; imshow(tom_norm(max(vol_rot,[],3),1)');

% rotate back:
% for fib to sem:
[euler_out shift_out rott]=tom_sum_rotation([179.363 151.634 -77.957;-154.643 -176.247 25.028],[0 0 0; 0 0 0]);
% for fib to tem:
[euler_out shift_out rott]=tom_sum_rotation([179.363 151.634 -77.957;-154.643 -176.247 25.028; 0 0 34],[0 0 0; 0 0 0; 0 0 0]);

vol_rot_back = tom_rotate(vol_rot,euler_out);
% simple version:
vol_rot = tom_rotate(vol,[0 0 -77.957]);

imwrite(tom_norm(max(vol_rot_back,[],3),1)','/fs/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area5/Area5_processed_deconv/vol_cut_rot_back_SEM_ch0.tif');

31.07.2015:
clear;
[euler_out shift_out rott]=tom_sum_rotation([179.363 151.634 -77.957;-154.643 -176.247 25.028],[0 0 0; 0 0 0]);
raw = tom_rawread('/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area5/Area5_deconvoluted_measuredPSF/area5-0_decon_aligned_ch01_reslized.raw','uint16','be',[1540 1253 107],0,0);
raw = single(raw);
raw = quadvol(raw,0);
vol_rot = tom_rotate(raw,[-151.634 -179.363 77.957]);pushover('First Rotation Finished');
imwrite(tom_norm(max(vol_rot,[],3),1)','/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area5/Area5_deconvoluted_measuredPSF/vol_rot_FIB_ch1.tif');
vol_rot(1:(492.52013809+83.8895281933),:,:)=0;
vol_rot((616.800920598+83.8895281933):end,:,:)=0;
vol_rot(:,1:(504.027617952+275.500575374),:)=0;
vol_rot(:,(506.329113924+275.500575374):end,:)=0;
imwrite(tom_norm(max(vol_rot,[],3),1)','/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area5/Area5_deconvoluted_measuredPSF/vol_rot_cut_FIB_ch1.tif');
vol_rot_back = tom_rotate(vol_rot,euler_out);pushover('Back Rotation Finished');
imwrite(tom_norm(max(vol_rot_back,[],3),1)','/fs/gpfs03/lv03/pool/pool-plitzko/Jan_Arnold/correlation_HeLa_Area5/Area5_deconvoluted_measuredPSF/vol_rot_cut_SEM_ch1.tif');
